package main

import (
	"fmt"
	"os"
	"strings"
	"text/template"
)

const viewTemplate = `// Code generated by go generate; DO NOT EDIT.
package ecs

import (
	"iter"
	"unsafe"
)

{{range .Count}}
{{$n := .}}
// -------------- View{{$n}} --------------

type View{{$n}}[{{params $n}}] struct {
	queryCore
	ids [{{$n}}]ComponentID
}

type Row{{$n}}[{{params $n}}] struct {
	{{fields $n}}
}

func NewView{{$n}}[{{params $n}}](reg *Registry) *View{{$n}}[{{types $n}}] {
	{{registration $n}}

	ids := [{{$n}}]ComponentID{ {{idList $n}} }
	
	var mask ArchetypeMask
	for _, id := range ids {
		mask = mask.Set(id)
	}

	return &View{{$n}}[{{types $n}}]{
		queryCore: newQueryCore(reg, mask),
		ids:       ids,
	}
}

func (v *View{{$n}}[{{types $n}}]) All() iter.Seq2[Entity, Row{{$n}}[{{types $n}}]] {
	return func(yield func(Entity, Row{{$n}}[{{types $n}}]) bool) {
		for _, arch := range v.archetypes {
			{{setup $n}}

			for i := 0; i < arch.len; i++ {
				entity := arch.entities[i]
				row := Row{{$n}}[{{types $n}}]{
					{{rowFields $n}},
				}

				if !yield(entity, row) {
					return
				}

				{{advance $n}}
			}
		}
	}
}
{{end}}
`

func main() {
	funcMap := template.FuncMap{
		"params": func(n int) string {
			p := make([]string, n)
			for i := 0; i < n; i++ {
				p[i] = fmt.Sprintf("T%d any", i+1)
			}
			return strings.Join(p, ", ")
		},
		"types": func(n int) string {
			p := make([]string, n)
			for i := 0; i < n; i++ {
				p[i] = fmt.Sprintf("T%d", i+1)
			}
			return strings.Join(p, ", ")
		},
		"fields": func(n int) string {
			f := make([]string, n)
			for i := 0; i < n; i++ {
				f[i] = fmt.Sprintf("V%d *T%d", i+1, i+1)
			}
			return strings.Join(f, "; ")
		},
		"registration": func(n int) string {
			var lines []string
			for i := 1; i <= n; i++ {
				lines = append(lines, fmt.Sprintf("id%d := ensureComponentRegistered[T%d](reg.componentsRegistry)", i, i))
			}
			return strings.Join(lines, "\n\t")
		},
		"idList": func(n int) string {
			var ids []string
			for i := 1; i <= n; i++ {
				ids = append(ids, fmt.Sprintf("id%d", i))
			}
			return strings.Join(ids, ", ")
		},
		"setup": func(n int) string {
			var res []string
			for i := 0; i < n; i++ {
				res = append(res, fmt.Sprintf("ptr%d := arch.columns[v.ids[%d]].data", i+1, i))
				res = append(res, fmt.Sprintf("size%d := uintptr(arch.columns[v.ids[%d]].itemSize)", i+1, i))
			}
			return strings.Join(res, "\n\t\t\t")
		},
		"rowFields": func(n int) string {
			var res []string
			for i := 0; i < n; i++ {
				res = append(res, fmt.Sprintf("V%d: (*T%d)(ptr%d)", i+1, i+1, i+1))
			}
			return strings.Join(res, ",\n\t\t\t\t\t")
		},
		"advance": func(n int) string {
			var res []string
			for i := 0; i < n; i++ {
				res = append(res, fmt.Sprintf("ptr%d = unsafe.Add(ptr%d, size%d)", i+1, i+1, i+1))
			}
			return strings.Join(res, "\n\t\t\t\t")
		},
	}

	tmpl := template.Must(template.New("ecs").Funcs(funcMap).Parse(viewTemplate))
	f, err := os.Create("views_gen.go")
	if err != nil {
		panic(err)
	}
	defer f.Close()

	tmpl.Execute(f, struct{ Count []int }{Count: []int{1, 2, 3, 4, 5, 6}})
}
