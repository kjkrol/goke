package main

import (
	"fmt"
	"os"
	"strings"
	"text/template"
)

const viewTemplate = `// Code generated by go generate; DO NOT EDIT.
package ecs

import (
	"iter"
	"unsafe"
)
{{range .Count}}
{{$n := .}}
// -------------- View{{$n}} --------------

type View{{$n}}[{{params $n}} any] struct {
	viewBase
	ids [{{$n}}]ComponentID
}

type Row{{$n}}[{{params $n}} any] struct {
	{{fields $n}}
}

func (r Row{{$n}}[{{types $n}}]) Values() ({{params_ptrs $n}}) {
	return {{row_returns $n}}
}

func NewView{{$n}}[{{params $n}} any](reg *Registry) *View{{$n}}[{{types $n}}] {
	{{registration $n}}
	ids := [{{$n}}]ComponentID{ {{idList $n}} }
	
	var mask ArchetypeMask
	for _, id := range ids {
		mask = mask.Set(id)
	}

	v := &View{{$n}}[{{types $n}}]{
		viewBase: viewBase{
			reg:  			 reg,
			mask: 			 mask,
			entityArchLinks: reg.archetypeRegistry.entityArchLinks,
		},
		ids: ids,
	}
	
	v.Reindex() 
	return v
}

func (v *View{{$n}}[{{types $n}}]) All() iter.Seq2[Entity, Row{{$n}}[{{types $n}}]] {
	return func(yield func(Entity, Row{{$n}}[{{types $n}}]) bool) {
		for _, arch := range v.matched {
			if arch.len == 0 {
				continue
			}

			{{- range $i := seq $n}}
			col{{add $i 1}} := arch.columns[v.ids[{{$i}}]]
			ptr{{add $i 1}} := col{{add $i 1}}.data
			size{{add $i 1}} := uintptr(col{{add $i 1}}.itemSize)
			{{- end}}

			for i := 0; i < arch.len; i++ {
				if !yield(arch.entities[i], Row{{$n}}[{{types $n}}]{ {{row_fields_all $n}} }) {
					return
				}
				{{advance $n}}
			}
		}
	}
}

func (v *View{{$n}}[{{types $n}}]) Filtered(entities []Entity) iter.Seq2[Entity, Row{{$n}}[{{types $n}}]] {
    return func(yield func(Entity, Row{{$n}}[{{types $n}}]) bool) {
        var lastArch *Archetype
        {{- range $i := seq $n}}
        var c{{add $i 1}} *column
        {{- end}}

        for _, e := range entities {
			backLink := v.viewBase.entityArchLinks[e.Index()]
            arch := backLink.arch
            if arch == nil || !arch.mask.Contains(v.mask) {
                continue
            }

            if arch != lastArch {
                {{- range $i := seq $n}}
                c{{add $i 1}} = arch.columns[v.ids[{{$i}}]]
                {{- end}}
                lastArch = arch
            }

            idx := backLink.columnIndex
            row := Row{{$n}}[{{types $n}}]{
                {{- range $i := seq $n}}
                V{{add $i 1}}: (*T{{add $i 1}})(unsafe.Add(c{{add $i 1}}.data, uintptr(idx)*c{{add $i 1}}.itemSize)),
                {{- end}}
            }

            if !yield(e, row) {
                return
            }
        }
    }
}
{{end}}
`

func main() {
	funcMap := template.FuncMap{
		"add": func(a, b int) int { return a + b },
		"seq": func(n int) []int {
			res := make([]int, n)
			for i := 0; i < n; i++ {
				res[i] = i
			}
			return res
		},
		"params": func(n int) string {
			p := make([]string, n)
			for i := 0; i < n; i++ {
				p[i] = fmt.Sprintf("T%d", i+1)
			}
			return strings.Join(p, ", ")
		},
		"types": func(n int) string {
			p := make([]string, n)
			for i := 0; i < n; i++ {
				p[i] = fmt.Sprintf("T%d", i+1)
			}
			return strings.Join(p, ", ")
		},
		"params_ptrs": func(n int) string {
			p := make([]string, n)
			for i := 0; i < n; i++ {
				p[i] = fmt.Sprintf("*T%d", i+1)
			}
			return strings.Join(p, ", ")
		},
		"fields": func(n int) string {
			f := make([]string, n)
			for i := 0; i < n; i++ {
				f[i] = fmt.Sprintf("V%d *T%d", i+1, i+1)
			}
			return strings.Join(f, "; ")
		},
		"row_returns": func(n int) string {
			p := make([]string, n)
			for i := 0; i < n; i++ {
				p[i] = fmt.Sprintf("r.V%d", i+1)
			}
			return strings.Join(p, ", ")
		},
		"registration": func(n int) string {
			var lines []string
			for i := 1; i <= n; i++ {
				lines = append(lines, fmt.Sprintf("id%d := ensureComponentRegistered[T%d](reg.componentsRegistry)", i, i))
			}
			return strings.Join(lines, "\n\t")
		},
		"idList": func(n int) string {
			var ids []string
			for i := 1; i <= n; i++ {
				ids = append(ids, fmt.Sprintf("id%d", i))
			}
			return strings.Join(ids, ", ")
		},
		"row_fields_all": func(n int) string {
			var res []string
			for i := 0; i < n; i++ {
				res = append(res, fmt.Sprintf("V%d: (*T%d)(ptr%d)", i+1, i+1, i+1))
			}
			return strings.Join(res, ", ")
		},
		"advance": func(n int) string {
			var res []string
			for i := 0; i < n; i++ {
				res = append(res, fmt.Sprintf("ptr%d = unsafe.Add(ptr%d, size%d)", i+1, i+1, i+1))
			}
			return strings.Join(res, "\n\t\t\t\t")
		},
	}

	tmpl := template.Must(template.New("ecs").Funcs(funcMap).Parse(viewTemplate))
	f, err := os.Create("views_gen.go")
	if err != nil {
		panic(err)
	}
	defer f.Close()

	tmpl.Execute(f, struct{ Count []int }{Count: []int{1, 2, 3, 4, 5, 6}})
}
